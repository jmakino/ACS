ACSDOC revision work memo

J. Makino Nov 17 2005

Here I try to record as much as thoughts and actual works.

First, there need to an easy way to record changes. It would be okay
to use svn to record every changes. So one liner

svn commit -m "working change for acsdoc2" --non-interactive

would do the recording. Test:

acssvn commit -m "working-change-for-acsdoc2"
Adding         kali/vol/documentation/acsdoc2.rb
Deleting       kali/vol/documentation/ascdoc2.rb

Fine, except that it takes rather long time.

The following will print the change between the latest committed
version and last change:

svn diff -r COMMITTED acsdoc2.rb

Thus, by having a script:

#!/bin/csh -f
setenv SVN_SSH "ssh -l acs"
setenv LANG C
date >> acsdoc-rev-memo
svn diff -r COMMITTED acsdoc2.rb >> acsdoc-rev-memo
svn commit -m "working-change-for-acsdoc2" --non-interactive >> acsdoc-rev-memo

I should be able to record all changes in the file acsdoc-rev-memo
(which is this file)

Fri Nov 18 06:13:23 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1369)
+++ acsdoc2.rb	(working copy)
@@ -20,6 +20,8 @@
 # string as an argument
 #
 # 2005/11/17 created acsdoc2.rb
+# test for more change
+# more changes
 #
 #==============================================================================
 #$DEBUG=1
Sending        documentation/acsdoc2.rb
Transmitting file data .
Committed revision 1370.

Okay, this works.

Currently, acsdoc for HTML generation works in the following steps:

1) create .foo.cp files, from foo.cp file
   it also generates .bar.rb files from bar.rb files. This part need
    not be changed
  
2) calling rdoc for .foo.cp files

3) doing many postprocessing....

So let us first make the following changes:

1) instead of making .foo.cp files, create foo.html files
2) do not call rdoc
3) do not remove .foo.cp files (since they are not created)

Questions: Should HTML files be at the same directory as cp files?
Well, perhaps it is, since there would not be other good place...

First the first step

Fri Nov 18 06:49:49 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1370)
+++ acsdoc2.rb	(working copy)
@@ -1,18 +1,10 @@
 #!/usr/bin/ruby
 #
-# acsdoc.rb
+# acsdoc2.rb
 #
-# This script takes a number of files and runs rdoc ("rdoc.sourceforge.net")
-# on them.  All options normally given to rdoc on the command line are
-# passed on to rdoc.
+# This script takes a number of files and make HTML or LaTeX files from them. 
+# usage:  ruby acsdoc.rb [--tolatex]   [file]...
 #
-# As an internal detail, this script generates for each .cp file "filename.cp"
-# a temporary file ".filename.cp", which is removed before the script finishes.
-# If acsdoc.rb is invoked with the option "--keep-dot-files", these temporary
-# files are not removed
-#    s
-# usage:  ruby acsdoc.rb [--keep-dot-files] [--tolatex]  [rdoc option]... [file]...
-#
 # 2004/3/22 Major rewrite to make it more easily extensible.
 #
 # Basic change: all functions are changed to (if not already designed
@@ -1637,7 +1629,6 @@
 load_old_aux
 load_volindex
 del_flag = true
-del_file_list = Array.new
 tolatex_flag = false
 
 ARGV.collect! do |a|
@@ -1645,14 +1636,13 @@
     extention = "."+$1
     if FileTest.size?(a)
       unless tolatex_flag 
-	dot_a = File.dirname(a)+"/."+File.basename(a);
+	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
       else
 	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".tex"
       end
       $current_cp_filename = a
       prep_cp(a, dot_a, tolatex_flag)
       a = dot_a
-      del_file_list.push(dot_a)
     else
       a = ""
     end
@@ -1679,9 +1669,6 @@
       a = ""
     end
     a
-  elsif a == "--keep-dot-files"
-    del_flag = false
-    a = ""
   elsif a == "--tolatex"
     tolatex_flag = true
     del_flag = false
@@ -1701,22 +1688,11 @@
 end
 
 unless tolatex_flag
-  print "rdoc #{coptions} #{ARGV.join(" ")} \n" 
-  unless system("rdoc #{coptions} #{ARGV.join(" ")}") 
-# This part is to work around some unfixed bug in rdoc
-    system("touch .zdummy")
-    system("rdoc #{coptions} #{ARGV.join(" ")} .zdummy") 
-  end
-  add_toc
-  process_css
-  dump_aux
+#  add_toc
+#  process_css
+#  dump_aux
 end
 
-create_navigations_for_cp_files(ARGV)
-if del_flag
-  del_file_list.each do |f|
-    File.delete(f)
-  end
-end
+#create_navigations_for_cp_files(ARGV)
 
 # :segment end:
Adding         documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1371.

<yebisu:/home/makino/acs/kali/vol/documentation>acsdoc2.rb ch02.ok
acsdoc2.rb:491: warning: regexp has `}' without escape
acsdoc2.rb:1424: warning: regexp has `}' without escape
Loading initialization file .acsdocinitrc
Common initialization file loaded from etc/acsdocinitrc
acsdoc2.rb:1698: undefined local variable or method `del_file_list' for #<Object:0xb7d399c0 @previous_is_command=nil> (NameError)
<yebisu:/home/makino/acs/kali/vol/documentation>up

Fri Nov 18 07:02:51 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1372.

Fri Nov 18 07:09:07 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1373.

Now HTML file is made, but with the old content of .foo.cp file

Question is how to structure the source code. Current structure of the
make code is:

    unless tolatex_flag
      s = convert_link_to_rdoc_style(instring,dirname)
    else
      s = instring
    end
    tmpstring=prep_cp_string(s,dirname,infile).split("\n");
    if tolatex_flag
b      tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
    else
      tmp2= Rdoctotex::latex_process_tex_mathmarkup(tmpstring)
      tmp2= find_and_process_tex_inlines(tmp2,dirname);
      tmp2= find_and_process_tex_equations(tmp2,dirname);
      tmp2= find_and_process_figures(tmp2,dirname);
      tmp2= find_and_process_generic_tag(tmp2,dirname,"nosectionnumber",
					 "process_nosectionnumber")
      tmp2= process_toc(tmp2,infile);
      tmp2= process_section_headers(tmp2,infile)
      tmp2= process_tex_labels(tmp2,dirname);
      tmp2= process_tex_weblinks(tmp2)
      tmp2= process_some_special_characters(tmp2)
    end

So, basically by changing the functions in the last else block, I can
generate HTML directly. I guess I just try that for now.

      tmp2= find_and_process_tex_inlines(tmp2,dirname);

This one actually touch process_tex_inlines
which then call process_texcod
Fri Nov 18 09:21:37 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1371)
+++ acsdoc2.rb	(working copy)
@@ -878,7 +878,7 @@
       raise "Failed to create the jpeg file #{texbase}.jpeg"
     end
     @@imgcount+=1
-    "link:../#{imgname}"
+    "<IMG SRC=#{imgname}"
   end
 
   def process_tex_inlines(s,instring,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1374.

One bug found: IMG tag not closed.

Fri Nov 18 09:23:46 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1374)
+++ acsdoc2.rb	(working copy)
@@ -878,7 +878,7 @@
       raise "Failed to create the jpeg file #{texbase}.jpeg"
     end
     @@imgcount+=1
-    "<IMG SRC=#{imgname}"
+    "<IMG SRC=#{imgname}>"
   end
 
   def process_tex_inlines(s,instring,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1375.

Now find_and_process_tex_inlines seems to do something reasonable,
making for example 

 It seems to fail in a strange way in some cases. This is apparently
  a problem with rdoc. For example, <IMG SRC=.imgs/1.jpeg>
  but I suspect after \<tex> this </tex>, the next thing will fail
  <IMG SRC=.imgs/2.jpeg> for unknown reason.

Next thing is  find_and_process_tex_equations. This seems to be done
correctly by previous one. No changes made.

Now figures:  find_and_process_figures. It should create something like:

<p>
<a name=tiogaicon> <img ALIGN="middle"
src="../../../.imgs/1_tioga_icon.ps.jpeg">
</p>
<pre>
 Figure 1: Icon for Tioga system
</pre>

Fri Nov 18 09:35:06 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1379.

Need to change copy_figure_file

Fri Nov 18 10:05:06 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1381)
+++ acsdoc2.rb	(working copy)
@@ -1003,7 +1003,7 @@
     p imgname  if $DEBUG
     system "convert #{dirname}/#{figurefilename} #{imgname}"
     system "mv -f #{imgname}.0 #{imgname}"if File.exist?(imgname + ".0")
-    "../"+imgname
+    imgname
   end
 
   @@figure_number =0
@@ -1014,7 +1014,7 @@
     figurefilename,size,label = a[1],a[2],a[3]
     @@tex_labels[label]=@@figure_number
     @@tex_labels_filename[label]=$current_cp_filename
-    namelabel = "<name>" + label + "</name>\n"
+    namelabel = "<a name=#{label}>\n"
     caption = ""
     while (s = instring.shift ) =~ /\S/
       caption += s + "\n"
@@ -1023,8 +1023,8 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    namelabel + "link:"+filename_to_link+"\n\n Figure " +
-      @@figure_number.to_s + ": " + caption + "\n\n"
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>+
+    "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1382.
Fri Nov 18 10:06:07 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1382)
+++ acsdoc2.rb	(working copy)
@@ -1023,7 +1023,7 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>+
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>"+
     "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1383.

Figure seems to be okay.

Generic tag:

      tmp2= find_and_process_generic_tag(tmp2,dirname,"nosectionnumber",
					 "process_nosectionnumber")

process_nosectionnumber does something...

Currently it does not do anything. Seems to be okay to ignore it.

      tmp2= process_toc(tmp2,infile);

This will create: TOCTOCTOCTOC, which should be post-processed (I think)

tmp2= process_section_headers(tmp2,infile)

Fri Nov 18 10:25:05 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1383)
+++ acsdoc2.rb	(working copy)
@@ -1108,7 +1108,7 @@
       sectionlabel="rdocsect"+@@sectionheadercounter.to_s
       @@sectionheaders.push [sectionlabel,sectionlevel,sectionname,filename]
       @@sectionheadercounter+= 1
-      s+"\n<name>" + sectionlabel + "</name>\n"
+      s+"<name>" + sectionlabel + "</name>\n"
     }
   end
 
@@ -1121,7 +1121,7 @@
       if str =~ /^\s*:label:\s/
 	labeltext=str.split[1]
         labeltext = "sect:"+labeltext if labeltext !~ /^sect/
-        ostring+= "<name>#{labeltext}</name>"
+        ostring+= "<a name=#{labeltext}>"
 	@@tex_labels[labeltext]=lastsectionnumber
         @@tex_labels_filename[labeltext]=$current_cp_filename
 	print "Label #{labeltext} as #{lastsectionnumber}\n"
@@ -1145,7 +1145,7 @@
 	  @@section_label_table[labeltext]=sectionlabel
           lastsectionnumber=number_label[0,number_label.length-1]
 	  labeltext=nil
-	  "="*sectionlevel+ " "+sectionname+ "\n<name>" + sectionlabel + "</name>\n"
+	   "<h2> "+sectionname+ "</h2>\n<a name=" + sectionlabel + ">\n"
 	} 
 	ostring +=x
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1384.


      tmp2= process_tex_labels(tmp2,dirname);

Fri Nov 18 10:33:52 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1384)
+++ acsdoc2.rb	(working copy)
@@ -1077,20 +1077,21 @@
         reallabel = $2
         filename, tag=getauxlabel(dirname,reallabel)
         if filename
-          "("+tag+")["+filename+"\#"+reallabel+"]"
+          "<a href=#{filename}\##{reallabel}>#{tag}>"
         else
           "(unknown label #{label})"
         end
       elsif @@tex_labels[label] 
-#        if @@tex_labels_filename[label]==$current_cp_filename
-#          "<ntaga>"+ label + "</ntaga><ntagb>"+ @@tex_labels[label].to_s+ "</ntagb>"
-#        else
-        "("+@@tex_labels[label].to_s+")["+
-          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
-#        end
+#        "("+@@tex_labels[label].to_s+")["+
+#          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
+          "<a href="+to_rdocname(@@tex_labels_filename[label])+"\#"+label+">"+
+          @@tex_labels[label].to_s+">"
       elsif @@old_tex_labels[label]
-          "("+@@old_tex_labels[label].to_s+")["+
-            to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+"]"
+#          "("+@@old_tex_labels[label].to_s+")["+
+#            
+          "<a href="+
+             to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+">"+
+          @@old_tex_labels[label].to_s+">"
       else
         "(unknown label #{label})"
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1385.

The form of the link looks okay. The file name is not.

Fri Nov 18 10:38:53 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1385)
+++ acsdoc2.rb	(working copy)
@@ -1691,7 +1691,7 @@
 unless tolatex_flag
 #  add_toc
 #  process_css
-#  dump_aux
+   dump_aux
 end
 
 #create_navigations_for_cp_files(ARGV)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1386.

local file names: to_rdocname
nonlocal file names: getauxlabel?

Fri Nov 18 10:46:11 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1386)
+++ acsdoc2.rb	(working copy)
@@ -1043,8 +1043,12 @@
     ostring
   end
 
-  def to_rdocname(name)
-    "_"+name.gsub(/\./,"_")+".html"
+#  def to_rdocname(name)
+#    "_"+name.gsub(/\./,"_")+".html"
+#  end
+
+  def to_htmlname(a)
+    File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
   end
 
   def getauxlabel(dirname, label)
@@ -1053,8 +1057,8 @@
       x = Marshal.load(open(dirname+"/"+@@auxfilename,"r"))
       tex_labels, tex_labels_filename,  section_label_table,  sectionheaders = x
       if tex_labels[label]
-        location = "../../../"+dirname+"/doc/files/_/"+
-          to_rdocname(tex_labels_filename[label])
+        location = "../"+dirname+"/"+
+          to_htmlname(tex_labels_filename[label])
         newtag=@@volindex[dirname[3,dirname.length]]
         tag =  newtag ? "v"+newtag.to_s : dirname+"."
         return [location,tag+tex_labels[label].to_s]
@@ -1084,13 +1088,13 @@
       elsif @@tex_labels[label] 
 #        "("+@@tex_labels[label].to_s+")["+
 #          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
-          "<a href="+to_rdocname(@@tex_labels_filename[label])+"\#"+label+">"+
+          "<a href="+to_htmlname(@@tex_labels_filename[label])+"\#"+label+">"+
           @@tex_labels[label].to_s+">"
       elsif @@old_tex_labels[label]
 #          "("+@@old_tex_labels[label].to_s+")["+
 #            
           "<a href="+
-             to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+">"+
+             to_htmlname(@@old_tex_labels_filename[label])+"\#"+label+">"+
           @@old_tex_labels[label].to_s+">"
       else
         "(unknown label #{label})"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1387.

    acsdoc2.rb:1051:in `to_htmlname': undefined local variable or method `extention' for #<Object:0xb7d399c0 @previous_is_command=nil> (NameError)
        from acsdoc2.rb:1091:in `process_tex_labels'
        from acsdoc2.rb:1076:in `gsub'
        from acsdoc2.rb:1076:in `process_tex_labels'
        from acsdoc2.rb:1223:in `prep_cp'
        from acsdoc2.rb:1649
        from acsdoc2.rb:1639:in `collect!'
        from acsdoc2.rb:1639

Error: $current_extention created to fix. Not quite clean...

Fri Nov 18 10:49:37 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1387)
+++ acsdoc2.rb	(working copy)
@@ -1048,7 +1048,7 @@
 #  end
 
   def to_htmlname(a)
-    File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
+    File.dirname(a)+"/"+File.basename(a,$current_extention)+ ".html"
   end
 
   def getauxlabel(dirname, label)
@@ -1639,6 +1639,7 @@
 ARGV.collect! do |a|
   if a =~ /\.((cp)|(ok))$/
     extention = "."+$1
+    $current_extention=extention
     if FileTest.size?(a)
       unless tolatex_flag 
 	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1388.
Fri Nov 18 10:51:46 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1388)
+++ acsdoc2.rb	(working copy)
@@ -1057,7 +1057,7 @@
       x = Marshal.load(open(dirname+"/"+@@auxfilename,"r"))
       tex_labels, tex_labels_filename,  section_label_table,  sectionheaders = x
       if tex_labels[label]
-        location = "../"+dirname+"/"+
+        location = dirname+"/"+
           to_htmlname(tex_labels_filename[label])
         newtag=@@volindex[dirname[3,dirname.length]]
         tag =  newtag ? "v"+newtag.to_s : dirname+"."
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1389.

lables and filenames now looks okay.

tmp2= process_tex_weblinks(tmp2)



Fri Nov 18 10:57:30 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1389)
+++ acsdoc2.rb	(working copy)
@@ -1174,10 +1174,10 @@
       if linktext =~ /(.*)\|(.*)/m
 	url=($1)
 	text=$2
-	s="(#{text})[#{url}]"
       else
-	s="(#{linktext})[#{linktext}]"
+        url=text=linktext
       end
+      s="<a href=#{url}>#{text}>"
       blank+s.gsub(/\s/m," ")
     }
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1390.

This creates:

<a href=http:www.artcompsci.org>ACS homepage>.

Fri Nov 18 10:59:08 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1390)
+++ acsdoc2.rb	(working copy)
@@ -1177,7 +1177,7 @@
       else
         url=text=linktext
       end
-      s="<a href=#{url}>#{text}>"
+      s="<a href=#{url}>#{text}</a>"
       blank+s.gsub(/\s/m," ")
     }
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1391.

This creates:

<a href=http:www.artcompsci.org>ACS homepage</a>.


  tmp2= process_some_special_characters(tmp2)
 This one looks at: expand()

 Not sure if this is meaningful or not...

Now, things which is done in tex conversion must be added:


    s=process_include(instring)

This is probably the same

Fri Nov 18 11:06:53 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1391)
+++ acsdoc2.rb	(working copy)
@@ -1223,6 +1223,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
+      tmp2= Rdoctotex::process_include(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1392.
Fri Nov 18 11:08:01 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1392)
+++ acsdoc2.rb	(working copy)
@@ -1213,6 +1213,7 @@
       tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
     else
       tmp2= Rdoctotex::latex_process_tex_mathmarkup(tmpstring)
+      tmp2= Rdoctotex::process_include(tmp2)
       tmp2= find_and_process_tex_inlines(tmp2,dirname);
       tmp2= find_and_process_tex_equations(tmp2,dirname);
       tmp2= find_and_process_figures(tmp2,dirname);
@@ -1223,7 +1224,6 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2= Rdoctotex::process_include(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1393.

Seems to do something reasonable

    s=latex_process_tex_mathmarkup(s)
    s=latex_process_tex_equations(s)
    s=latex_process_tex_weblinks(s)
    s=latex_find_and_process_figures(s,dirname)

These are done already

    s=process_single_paragraphs_lists_etc(s,0,0,1,0)

What is this???

Fri Nov 18 11:19:45 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1393)
+++ acsdoc2.rb	(working copy)
@@ -570,6 +570,98 @@
   @@section_label_table={}
 
   @@section_counters=[]
+
+  @@listtypes=[
+    ["paragraph","p"],
+    ["ulist*","ul"],
+    ["ulist-","ul"],
+    ["nlist", "ol"],
+    ["verbatim","pre"]]
+
+
+  def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+    s_prev = ""
+    ostr=[]
+    ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
+
+    intex = nil
+
+#
+# intex is used to suppress formatting. As you can see from the code below, 
+# suppression can take place only if "<tex>" appears as single item in one 
+# line, and suppression stops only of "</tex>" appears as single item in one
+# line. So if you use them in a more complex ways, it might cause strange 
+# problems.
+#
+    while s=instring.shift
+      header_candidate =s.split[0] 
+      new_item = nil
+      new_type = 1
+      if @@intex_state == 1
+	new_type = type
+	new_indet = indent
+	s1 = s
+      elsif (/^(\*|\-|\d+\.)$/ =~ header_candidate) 
+	new_type = 1+[/\*/,/\-/,/\d+\./].collect{
+	  |x| x=~ header_candidate}.index(0)
+
+	s1 = s.sub(/\S+\s/){|x| " "*x.length} 
+	new_indent = /\S/ =~ s1
+	new_item = 1
+      else
+	new_indent = /\S/ =~ s
+	new_indent = indent if /^\s*$/ =~s 
+	s1=s
+      end
+      if type == 4 and /^\s+/ =~s 
+	s1 = s
+	new_type=4
+	new_item = nil
+      end
+      if new_indent > indent and new_item == nil
+	new_type = 4 
+      end
+      s1= process_tex_special_chars(s1) unless new_type == 4
+      if new_indent > indent
+	instring.unshift(s)
+	new=1
+	new = nil if new_type == type and type == 4 
+	vlimit = indent+1 if new and new_type == 4
+	if new 
+	  ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+						     new_type,new,
+						     vlimit)
+	else
+	  ostr.push s1
+	  instring.shift
+	end
+      elsif new_indent == indent
+	if new_item
+	  if new_type != type
+	    ostr.push("</"+@@listtypes[type][1]+">")
+	    instring.unshift(s)
+	    ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+						       new_type,1,vlimit)
+	  end
+	  ostr.push("<li> ") if new_type < 4
+	end
+	ostr.push s1
+      else
+	if type == 4 and new_type==4 and new_indent > vlimit
+	  indent = new_indent
+	  ostr.push s1
+	else
+	  ostr.push("</"+@@listtypes[type][1]+">")
+	  instring.unshift(s)
+	  return ostr
+	end
+      end
+      s_prev = s
+    end	
+    ostr
+  end
+
+
   def setreuseoutput(value)
     @@reuseoutput = value
   end
@@ -1224,6 +1316,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
+      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1394.
Fri Nov 18 11:22:38 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1394)
+++ acsdoc2.rb	(working copy)
@@ -580,6 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+    instring = instring.split("\n")
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
@@ -658,7 +659,7 @@
       end
       s_prev = s
     end	
-    ostr
+    ostr.join("\n")
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1395.
Fri Nov 18 11:24:03 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1395)
+++ acsdoc2.rb	(working copy)
@@ -580,7 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
-    instring = instring.split("\n")
+    p instring
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1396.
Fri Nov 18 11:35:08 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1396)
+++ acsdoc2.rb	(working copy)
@@ -580,7 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
-    p instring
+    instring = instring.split("\n") if instring.class != Array
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1397.

    s=post_process_verbatim(s)

Do something if the previous line is blank? Seems unnecessary?

    s=process_link(s)

Fri Nov 18 11:48:19 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1397)
+++ acsdoc2.rb	(working copy)
@@ -571,6 +571,23 @@
 
   @@section_counters=[]
 
+  def process_link(instring)
+    instring = instring.split("\n") if instring.class != Array
+    ostring=[] 
+    while s=instring.shift
+      if /(^|\s)link\:(\S+)/  =~ s
+	imglinkfile = $2
+	s.sub!(/(^|\s)link\:(\S+)/,
+	       "\n<IMG src=#{imglinkfile}>\n")
+	@@imglinkcount+=1
+      end
+      ostring.push(s)
+    end
+    ostring
+  end
+
+
+
   @@listtypes=[
     ["paragraph","p"],
     ["ulist*","ul"],
@@ -1318,6 +1335,7 @@
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
       tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2= process_link(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1398.
Fri Nov 18 11:52:58 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1398)
+++ acsdoc2.rb	(working copy)
@@ -1313,11 +1313,7 @@
       instring.push(s)
     end
     ifile.close
-    unless tolatex_flag
-      s = convert_link_to_rdoc_style(instring,dirname)
-    else
-      s = instring
-    end
+    s = instring
     tmpstring=prep_cp_string(s,dirname,infile).split("\n");
     if tolatex_flag
       tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1399.

link: directly converted to IMG tag.



    s=process_wordmarkup(s,dirname)

Fri Nov 18 12:02:31 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1399)
+++ acsdoc2.rb	(working copy)
@@ -570,7 +570,38 @@
   @@section_label_table={}
 
   @@section_counters=[]
+  @@wordreplace=[
+    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"{\\tt", "}"],
+    [/(^|\W)\*(\w+)\*($|\W)/,"{\\bf", "}"],
+    [/(^|\W)\\_(\w+)\\_($|\W)/,"{\\it", "}"]
+  ]
+  
+  @@tagreplace=[
+    ["<tt>","</tt>","{\\tt", "}"],
+    ["<b>","</b>","{\\bf", "}"],
+    ["<em>","</em>","{\\it", "}"],
+    ["<i>","</i>","{\\it", "}"],
+    ["<tex>","</tex>","", ""]
+  ]
+  
 
+  def wordmarkup(instr)
+    @@wordreplace.each do |x| instr.gsub!(x[0]) do |word|
+	$1 + x[1]+ " " + $2 +x[2] + $3
+      end
+    end
+    instr
+  end
+
+  def process_wordmarkup(instring)
+    instring = instring.split("\n") if instring.class != Array
+    ostring = []
+    instring.each{|s| ostring.push(wordmarkup(s))}
+    ostring.join("\n")
+  end
+
+
+
   def process_link(instring)
     instring = instring.split("\n") if instring.class != Array
     ostring=[] 
@@ -583,7 +614,7 @@
       end
       ostring.push(s)
     end
-    ostring
+    ostring.join("\n")
   end
 
 
@@ -1332,6 +1363,8 @@
       tmp2= process_some_special_characters(tmp2)
       tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
+      tmp2=process_wordmarkup(tmp2)
+
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1401.
Fri Nov 18 12:05:20 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1401)
+++ acsdoc2.rb	(working copy)
@@ -571,9 +571,9 @@
 
   @@section_counters=[]
   @@wordreplace=[
-    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"{\\tt", "}"],
-    [/(^|\W)\*(\w+)\*($|\W)/,"{\\bf", "}"],
-    [/(^|\W)\\_(\w+)\\_($|\W)/,"{\\it", "}"]
+    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"<tt>", "</tt>"],
+    [/(^|\W)\*(\w+)\*($|\W)/,"<b>", "</b>"],
+    [/(^|\W)\\_(\w+)\\_($|\W)/,"<i>", "</i>"]
   ]
   
   @@tagreplace=[
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1402.

wordmarkup added.

    s=process_headers(s)   : already done
    s=process_refmarkup(s) : already done
    s=process_toc_latex(s) : already done
    s=process_ctrls(s)     : already done
    s = process_tagmarkup(s,dirname).join("\n") ???
    s= <<-END_TEXSOURCE
    #{@@basic_preambles_for_tex}
    #{@@additional_preambles_for_tex}
    \\begin{document}
       #{@@additional_commands_for_tex}
       #{s}
    \\end{document}
    END_TEXSOURCE
Fri Nov 18 12:15:19 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1403)
+++ acsdoc2.rb	(working copy)
@@ -1271,7 +1271,8 @@
 	@@tex_labels[labeltext]=lastsectionnumber
         @@tex_labels_filename[labeltext]=$current_cp_filename
 	print "Label #{labeltext} as #{lastsectionnumber}\n"
-
+      elsif /^---*$/ =~ str
+        ostring += "\n<hr>\n"
       else
 	x=str.gsub(/^(=+)\s*(.+)$/){|s| 
 	  sectionlevel = $1.length
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1404.

tried to change --- to hr

BUGS:

Link to figure is not quite right.

Fri Nov 18 12:29:51 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1404)
+++ acsdoc2.rb	(working copy)
@@ -1164,7 +1164,7 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>"+
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"#{filename_to_link}\"></p>"+
     "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1405.

Single change (hopefully...) correct figure. Not quite. since _ is
converted to \_ somewhere...

Something is wrong after processing figure.

File name becomes broken in process_single ...Fri Nov 18 12:48:59 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1405)
+++ acsdoc2.rb	(working copy)
@@ -445,7 +445,6 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
-      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -1362,7 +1361,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+#      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1406.
Fri Nov 18 12:49:31 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1406)
+++ acsdoc2.rb	(working copy)
@@ -445,6 +445,7 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
+      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -669,7 +670,6 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
-      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1407.
Fri Nov 18 13:25:36 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1408)
+++ acsdoc2.rb	(working copy)
@@ -627,6 +627,9 @@
     ["verbatim","pre"]]
 
 
+  def process_tex_specials(s)
+    s.gsub(/\\<tex>/,"&lt;tex>").gsub(/<\/tex>/,"&lt;/tex>")
+  end
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
     instring = instring.split("\n") if instring.class != Array
     s_prev = ""
@@ -670,6 +673,7 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
+      s1= process_tex_specials(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -1361,7 +1365,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-#      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..